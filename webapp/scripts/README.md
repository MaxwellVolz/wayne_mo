# Build Scripts

## fix-gltf-types.js

Post-processes TypeScript files generated by `gltfjsx` to fix common type errors.

### What it fixes:

1. **Removes invalid `GLTFAction[]` type** - This type doesn't exist in the three-stdlib package
2. **Replaces `JSX.IntrinsicElements['group']`** with `React.ComponentProps<'group'>` for better type compatibility
3. **Fixes type assertions** - Changes `as GLTFResult` to `as unknown as GLTFResult`
4. **Adds React import** - Ensures React is imported when using ComponentProps

### Usage:

```bash
# Fix a single file
node scripts/fix-gltf-types.js components/CityModelGenerated.tsx

# Or use the npm scripts (recommended)
npm run buildcity    # Generate city model + auto-fix
npm run buildtaxi    # Generate taxi model + auto-fix
npm run buildmodels  # Generate all models + auto-fix
```

### How it works:

The script:
1. Reads the generated TypeScript file
2. Uses regex to find and replace problematic patterns
3. Writes the corrected file back to disk
4. Reports what was fixed

This is automatically called after `gltfjsx` when using the npm build scripts.

### Manual generation (not recommended):

If you need to manually generate without auto-fix:

```bash
# Generate without fix (will have type errors!)
npx gltfjsx public/models/city_01.glb --output components/CityModelGenerated.tsx --types

# Then fix manually
node scripts/fix-gltf-types.js components/CityModelGenerated.tsx
```

**Always use the npm scripts instead** (`npm run buildcity`, etc.) to ensure fixes are applied.

## Recent Fixes (2025-12-28)

### Path Generation Fix

**Problem:** Taxis were teleporting between random nodes instead of following the path connections defined in Blender.

**Root Cause:**
1. The `getNextPath()` function was cycling through paths sequentially instead of following node connections
2. Reverse paths were being skipped (e.g., A→B existed but B→A was blocked)

**Solution:**
1. **Fixed `getNextPath()`** to parse path IDs and follow the graph:
   - Path ID format: `NodeA_to_NodeB`
   - When taxi finishes a path, extracts destination node `NodeB`
   - Finds all paths starting with `NodeB_to_*`
   - Randomly picks one if multiple options (intersections)

2. **Fixed path generation** to create directed paths:
   - Removed reverse path blocking
   - Now creates both `A→B` and `B→A` if both connections exist in Blender
   - Respects one-way paths (if only `A→B` exists in Blender)

**Result:** Taxis now smoothly follow the road network defined in Blender, properly handling intersections and loops.

### Model Path Fix

**Problem:** Generated components tried to load models from `/city_01.glb` instead of `/models/city_01.glb`, causing 404 errors.

**Solution:** Added path fixing to `fix-gltf-types.js`:
- Detects `useGLTF('/something.glb')` patterns
- Changes to `useGLTF('/models/something.glb')`
- Also fixes `useGLTF.preload()` calls

**Result:** Models load correctly from the `/public/models/` directory.
